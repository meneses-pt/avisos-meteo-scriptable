<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>Avisos IPMA ‚Äì Preview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #0B1220;
      --card: #111B2E;
      --muted: #A6B0C3;
      --text: #FFFFFF;

      --yellow: #FFE27A;
      --orange: #FFB86B;
      --red: #FF6B6B;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* Container simula largura de widget medium */
    .widget {
      width: 360px;
      height: 390px;          /* SIMULA WIDGET GRANDE */
      margin: 24px auto;
      padding: 12px;
      background: var(--bg);
      overflow: hidden;       /* como no iOS */
    }

    .content-area {
      height: calc(100% - 90px); /* header + subtitle + footer */
      overflow: hidden;         /* widgets N√ÉO fazem scroll */
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    header h1 {
      font-size: 16px;
      margin: 0;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 12px;
    }

    .subtitle {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 14px;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .content {
      display: grid;
      grid-template-columns: 1fr 160px;
      gap: 12px;
    }

    .timeline .row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .dot {
      font-size: 14px;
    }

    .level {
      font-size: 10px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .desc {
      font-size: 12px;
      line-height: 1.3;
      margin-bottom: 10px;
      color: #D5DBE7;
    }

    footer {
      margin-top: 12px;
      font-size: 10px;
      color: var(--muted);
    }
  </style>
</head>
<body>

<div class="widget">
  <header>
    <h1>Avisos IPMA</h1>
    <div id="pill" class="pill">‚Ä¶</div>
  </header>
  <div class="subtitle">Porto ¬∑ avisos</div>

  <div id="content" class="content-area"></div>

  <footer id="updated"></footer>
</div>

<script>
const ENDPOINT = "https://avisos-meteo.andremeneses.workers.dev/?area=PTO";

fetch(ENDPOINT)
  .then(r => r.json())
  .then(data => render(data.warnings || []))
  .catch(err => {
    document.getElementById("content").innerHTML =
      "<p style='color:red'>Erro a carregar dados</p>";
    console.error(err);
  });

function render(warnings) {
  const content = document.getElementById("content");
  content.innerHTML = "";

  if (!warnings.length) {
    content.innerHTML = "<p>Sem avisos relevantes.</p>";
    return;
  }

  const max = warnings.reduce((m, w) =>
    priority(w.level) > priority(m) ? w.level : m, "green");

  const pill = document.getElementById("pill");
  pill.textContent = warnings.length + " avisos";
  pill.style.background = bg(max);
  pill.style.color = fg(max);

  const groups = groupBy(warnings, w => w.type);

  Object.values(groups).forEach(group => {
    const card = document.createElement("div");
    card.className = "card";

    const header = document.createElement("div");
    header.className = "card-header";
    header.textContent = icon(group[0].type) + " " + group[0].type;
    card.appendChild(header);

    const contentGrid = document.createElement("div");
    contentGrid.className = "content";

    /* timeline */
    const tl = document.createElement("div");
    tl.className = "timeline";

    group
      .sort((a,b) => a.start.localeCompare(b.start))
      .forEach(w => {
        const row = document.createElement("div");
        row.className = "row";

        const d = document.createElement("span");
        d.className = "dot";
        d.textContent = "‚óè";
        d.style.color = fg(w.level);

        const t = document.createElement("span");
        t.textContent = period(w.start, w.end);

        row.append(d, t);
        tl.appendChild(row);
      });

    /* descriptions */
    const right = document.createElement("div");
    const seen = new Set();

    group.forEach(w => {
      if (seen.has(w.level)) return;
      seen.add(w.level);

      const l = document.createElement("div");
      l.className = "level";
      l.style.color = fg(w.level);
      l.textContent = label(w.level).toUpperCase();

      const d = document.createElement("div");
      d.className = "desc";
      d.textContent = w.text;

      right.append(l, d);
    });

    contentGrid.append(tl, right);
    card.appendChild(contentGrid);
    content.appendChild(card);
  });

  document.getElementById("updated").textContent =
    "Atualizado " + new Date().toLocaleTimeString("pt-PT", { hour: "2-digit", minute: "2-digit" });
}

/* helpers */

function groupBy(arr, fn) {
  return arr.reduce((m, x) => {
    const k = fn(x);
    (m[k] ||= []).push(x);
    return m;
  }, {});
}

function period(s, e) {
  const sd = new Date(s), ed = new Date(e);
  return sd.toLocaleDateString("pt-PT", { weekday: "short" }) +
    " " + sd.toLocaleTimeString("pt-PT", { hour: "2-digit", minute: "2-digit" }) +
    "‚Äì" + ed.toLocaleTimeString("pt-PT", { hour: "2-digit", minute: "2-digit" });
}

function priority(l) { return { green:1, yellow:2, orange:3, red:4 }[l] || 0; }
function label(l) { return { yellow:"Amarelo", orange:"Laranja", red:"Vermelho" }[l] || "Aviso"; }
function fg(l) { return { yellow:varY(), orange:varO(), red:varR() }[l] || "#ccc"; }
function bg(l) { return { yellow:"#3A3610", orange:"#3A2B10", red:"#3B1D1D" }[l] || "#15311F"; }

function icon(t) {
  t = t.toLowerCase();
  if (t.includes("agita√ß√£o") || t.includes("mar")) return "üåä";
  if (t.includes("vento")) return "üí®";
  if (t.includes("precip") || t.includes("chuva")) return "üåßÔ∏è";
  return "‚ö†Ô∏è";
}

function varY(){return getComputedStyle(document.documentElement).getPropertyValue("--yellow")}
function varO(){return getComputedStyle(document.documentElement).getPropertyValue("--orange")}
function varR(){return getComputedStyle(document.documentElement).getPropertyValue("--red")}
</script>

</body>
</html>
